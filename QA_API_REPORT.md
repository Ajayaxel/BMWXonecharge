# OneCharge API QA Analysis Report

**Date:** 2026-02-23  
**Status:** Completed Analysis (Diagnostic Only)

---

## üìä API Lifecycle & Call Frequency Report

The following categorization details the API calls based on their triggers and frequency within the current application architecture.

### 1. Authentication & Security
| API Endpoint | Trigger (Case) | Frequency | Status |
| :--- | :--- | :--- | :--- |
| `/customer/login` | Login Button Click | Once per attempt | ‚úÖ Optimized |
| `/customer/register` | Register Button Click | Once per attempt | ‚úÖ Optimized |
| `/customer/verify-otp` | Verify Button Click | Once per attempt | ‚úÖ Optimized |
| `/customer/logout` | Settings -> Logout | Once per session | ‚úÖ Optimized |

### 2. Vehicles (Critical Over-calling Identified)
| API Endpoint | Trigger (Case) | Frequency | Observation |
| :--- | :--- | :--- | :--- |
| `/customer/vehicles` (GET) | **1. App Launch** | 1st Call | Initiated by `VehicleListBloc` in `main.dart`. |
| `/customer/vehicles` (GET) | **2. SplashScreen** | 2nd Call | Explicitly called in `_checkAuthStatus()` logic. |
| `/customer/vehicles` (GET) | **3. HomeScreen Init** | 3rd Call | Called again in `HomeScreen.initState()`. |
| `/customer/brands` | App Launch | Once | Loaded globally in `main.dart`. |
| `/customer/vehicles/masters`| App Launch | Once | Loaded globally in `main.dart`. |

### 3. Support & Booking
| API Endpoint | Trigger (Case) | Frequency | Observation |
| :--- | :--- | :--- | :--- |
| `/customer/tickets` (POST) | "Book Now" Button | Once per booking | ‚úÖ Optimized |
| `/customer/tickets/driver-location/{id}`| Active Booking | **Every 5 seconds** | Intentional polling for real-time tracking. |
| `/customer/issues/categories` | App Launch | Once | Loaded globally in `main.dart`. |

---

## üö® Major "Over-call" Issues Identified

### 1. The Triple `getVehicles` Call
The app fetches the list of vehicles **three times** in rapid succession during startup:
1.  **Global Level:** In `main.dart`, the `VehicleListBloc` is created with `..add(FetchVehicles())`.
2.  **Navigation Level:** In `splash.dart`, the code manually creates a `VehicleRepository` and calls `getVehicles()` to decide whether to show the vehicle selection screen.
3.  **UI Level:** In `home_screen.dart`, the `initState` calls `FetchVehicles()` again.
*   **Impact:** Unnecessary server load and potential UI flickering as the list refreshes 3 times.

### 2. Eager Fetching without Authentication
In `main.dart`, almost all master data (Brands, Models, Categories, Locations, Profile) is fetched **immediately** when the app starts.
*   **The Issue:** These calls run even if the user is **logged out**.
*   **Observation:** The `ApiClient` logs `‚ö†Ô∏è [ApiClient] No token found` for 7+ requests every time a logged-out user opens the app.
*   **Impact:** 7+ failed API requests (401 Unauthenticated) on every app launch for new/logged-out users.

### 3. Redundant Master Data
`FetchBrands()`, `FetchVehicleModels()`, and `FetchChargingTypes()` are all called at once in `main.dart`.
*   **Suggestion:** These are only needed on the `VehicleSelection` screen. Fetching them upfront increases initial app load time and memory usage for data that might not be used in that session.

### 4. Polundant Polling Timer
The 5-second polling for driver location is triggered in `HomeScreen`.
*   **Observation:** While the code properly cancels the timer in `dispose()`, if the user navigates to a nested screen (e.g., Settings) and `HomeScreen` stays in the background, the polling continues.
*   **Impact:** Battery drain and unnecessary data usage if the user stays on a different screen for a long time during an active booking.

---

## üìã Recommendations Checklist
- [ ] **Consolidate Vehicle Fetching:** Use the `VehicleListBloc` state in `SplashScreen` instead of a manual repository call.
- [ ] **Authenticated Fetching:** Wrap `main.dart` initializations in a check that verifies the token exists first.
- [ ] **Lazy Load Masters:** Move Brand and Model fetching to the `VehicleSelection` screen specifically.
- [ ] **Lifecycle Polling:** Ensure the driver tracking poll only runs when the map/home screen is currently visible to the user.

---
*Report generated by Antigravity AI.*
